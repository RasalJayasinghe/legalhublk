name: Sync Legal Data (documents.gov.lk)

on:
  schedule:
    - cron: "0 */2 * * *"   # Every 2 hours for more frequent updates
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        job:
          - { cmd: "gazettes --from-year 2004 --to-year 2025 --out public/data/gazettes" }
          - { cmd: "extra-gazettes --from-year 2004 --to-year 2025 --out public/data/extra-gazettes" }
          - { cmd: "acts --out public/data/acts" }
          - { cmd: "bills --out public/data/bills" }
          - { cmd: "forms --out public/data/forms" }
          - { cmd: "notices --out public/data/notices" }
          - { cmd: "hf-acts-full --out public/data/hf-acts-full" }
          - { cmd: "hf-acts-chunks --out public/data/hf-acts-chunks" }
          - { cmd: "merge-latest --root public/data" }   # tiny, super-fast homepage/search feed
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install system dependencies and Rust
        run: |
          sudo apt-get update
          sudo apt-get install -y libxml2-dev libxslt-dev python3-dev build-essential
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source ~/.cargo/env
          rustc --version
          cargo --version
      - name: Install deps
        run: |
          source ~/.cargo/env
          python -m pip install --upgrade pip setuptools wheel
          pip install -r scrapers/requirements.txt
          # Install datasets package for Hugging Face integration
          pip install datasets>=2.14.0
      - name: Run ${{ matrix.job.cmd }}
        run: python -m scrapers.cli ${{ matrix.job.cmd }}
      - name: Commit changes (if any)
        run: |
          git config user.name  "gh-actions"
          git config user.email "actions@users.noreply.github.com"
          git add public/data || true
          if ! git diff --cached --quiet; then
            git commit -m "Sync: ${{ matrix.job.cmd }} @ $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            git push
          else
            echo "No changes."
          fi